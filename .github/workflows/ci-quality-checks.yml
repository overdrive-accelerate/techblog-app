# CI/CD Quality Checks Workflow for blog-app (Next.js Frontend)
# Runs comprehensive quality checks on every PR
# Includes: TypeScript type checking, code formatting validation, build verification
# Adapted from blog-api CI/CD pipeline

name: CI Quality Checks

on:
    pull_request:
        branches:
            - main
            - dev
    push:
        branches:
            - main
            - dev

# Cancel in-progress runs for the same PR/branch
concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Job 1: TypeScript Type Checking
    typecheck:
        name: TypeScript Type Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-blog-app-${{ hashFiles('**/bun.lockb') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-blog-app-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Set environment variables
              run: |
                  echo "NEXT_PUBLIC_API_URL=http://localhost:3001" >> $GITHUB_ENV
                  echo "NEXT_PUBLIC_SITE_URL=http://localhost:3000" >> $GITHUB_ENV

            - name: Run TypeScript type check
              run: bunx tsc --noEmit

    # Job 2: Code Formatting Check
    format-check:
        name: Code Formatting (Prettier)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-blog-app-${{ hashFiles('**/bun.lockb') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-blog-app-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Check Prettier formatting
              run: bunx prettier --check "**/*.{ts,tsx,js,json,yml,yaml}" --ignore-path .prettierignore

    # Job 3: Next.js Build Verification
    build-check:
        name: Next.js Build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-blog-app-${{ hashFiles('**/bun.lockb') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-blog-app-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Set environment variables
              run: |
                  echo "NEXT_PUBLIC_API_URL=http://localhost:3001" >> $GITHUB_ENV
                  echo "NEXT_PUBLIC_SITE_URL=http://localhost:3000" >> $GITHUB_ENV

            - name: Build Next.js application
              run: bunx next build
              env:
                  NEXT_TELEMETRY_DISABLED: 1

            - name: Verify build artifacts
              run: |
                  if [ ! -d ".next" ]; then
                    echo "❌ Build failed: .next directory not found"
                    exit 1
                  fi
                  echo "✅ Build successful"

    # Job 4: ESLint Check
    lint-check:
        name: ESLint
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-blog-app-${{ hashFiles('**/bun.lockb') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-blog-app-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run ESLint
              run: bun run lint

    # Job 5: Test Coverage (using Node.js for v8 coverage support)
    test-coverage:
        name: Test Coverage
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Setup Bun (for package manager)
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun/install/cache
                      node_modules
                  key: ${{ runner.os }}-deps-${{ hashFiles('**/bun.lockb') }}
                  restore-keys: |
                      ${{ runner.os }}-deps-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Set environment variables
              run: |
                  echo "NEXT_PUBLIC_API_URL=http://localhost:3001" >> $GITHUB_ENV
                  echo "NEXT_PUBLIC_SITE_URL=http://localhost:3000" >> $GITHUB_ENV

            - name: Run tests with coverage (Node.js runtime)
              run: npx vitest run --coverage

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              if: always()
              with:
                  files: ./coverage/coverage-final.json
                  flags: blog-app
                  name: blog-app-coverage
                  fail_ci_if_error: false

    # Job 6: Quality Gate (All checks must pass)
    quality-gate:
        name: Quality Gate
        runs-on: ubuntu-latest
        needs: [typecheck, format-check, build-check, lint-check, test-coverage]

        steps:
            - name: All checks passed
              run: |
                  echo "✅ All quality checks passed!"
                  echo "  - TypeScript type check: ✓"
                  echo "  - Code formatting: ✓"
                  echo "  - Next.js build: ✓"
                  echo "  - ESLint: ✓"
                  echo "  - Test coverage: ✓"
